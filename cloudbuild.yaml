# Cloud Build configuration for HSS Backend
# Triggers: develop branch (dev), v* tags (prod)

steps:
  # 0. Java 21 setup
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â˜• Java 21 kurulumu..."
        cd hss-backend
        # Java 21'i indir ve kur
        wget -q https://download.java.net/java/GA/jdk21.0.2/f2283986f49a4c0e92e48e9da5bd7e33/9/GPL/openjdk-21.0.2_linux-x64_bin.tar.gz
        tar -xzf openjdk-21.0.2_linux-x64_bin.tar.gz
        export JAVA_HOME=$(pwd)/jdk-21.0.2
        export PATH=$JAVA_HOME/bin:$PATH
        java -version
        echo "âœ… Java 21 kuruldu!"

  # 1. Test aÅŸamasÄ±
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ§ª Backend testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
        cd hss-backend
        export JAVA_HOME=$(pwd)/jdk-21.0.2
        export PATH=$JAVA_HOME/bin:$PATH
        ./mvnw -B test
        echo "âœ… Testler baÅŸarÄ±lÄ±!"

  # 2. Build aÅŸamasÄ±
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ”¨ Backend build ediliyor..."
        cd hss-backend
        export JAVA_HOME=$(pwd)/jdk-21.0.2
        export PATH=$JAVA_HOME/bin:$PATH
        ./mvnw -B clean package -DskipTests
        echo "âœ… Build baÅŸarÄ±lÄ±!"

  # 3. Docker image build
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${_TAG_NAME}'
      - '.'
    dir: 'hss-backend'

  # 4. Docker image push
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${_TAG_NAME}'

  # 5. Cloud Run deploy
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args: 
      - '-c'
      - |
        echo "ðŸš€ Cloud Run'a deploy ediliyor..."
        
        # Cloud Run deploy
        gcloud run deploy ${_SERVICE_NAME} \
          --image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA} \
          --region=${_REGION} \
          --service-account=${_SERVICE_ACCOUNT} \
          --platform=managed \
          --allow-unauthenticated \
          --set-env-vars=SPRING_PROFILES_ACTIVE=${_SPRING_PROFILE} \
          --set-env-vars=GCP_SQL_INSTANCE_CONNECTION_NAME=${_CONNECTION_NAME} \
          --set-secrets=DB_USERNAME=${_DB_USERNAME_SECRET}:latest,DB_PASSWORD=${_DB_PASSWORD_SECRET}:latest \
          --add-cloudsql-instances=${_CONNECTION_NAME} \
          --min-instances=${_MIN_INSTANCES} \
          --max-instances=${_MAX_INSTANCES} \
          --port=8080 \
          --memory=512Mi \
          --cpu=1 \
          --timeout=300 \
          --concurrency=80
        
        echo "âœ… Cloud Run deploy baÅŸarÄ±lÄ±: ${_SERVICE_NAME}"

  # 6. Release artifacts oluÅŸtur (sadece prod iÃ§in) 
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          echo "ðŸ“¦ Release artifacts oluÅŸturuluyor..."
          
          # Backend image referansÄ±
          echo "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}" > backend-image.txt
          
          # Manifest oluÅŸtur
          cat > manifest.json << EOF
        {
          "version": "${_VERSION}",
          "changes": ["Backend production deployment"],
          "artifacts": {
            "backend": "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}",
            "frontend": "https://storage.googleapis.com/${_BUCKET_NAME}/releases/${_VERSION}/frontend/"
          },
          "forced": false,
          "channel": "prod",
          "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
          
          # Cloud Storage'a yÃ¼kle
          gsutil -m cp backend-image.txt gs://${_BUCKET_NAME}/releases/${_VERSION}/
          gsutil -m cp manifest.json gs://${_BUCKET_NAME}/releases/${_VERSION}/
          
          # Latest pointer'Ä±nÄ± gÃ¼ncelle
          gsutil -m cp manifest.json gs://${_BUCKET_NAME}/releases/latest/manifest.json
          
          echo "âœ… Release artifacts oluÅŸturuldu!"
        else
          echo "â„¹ï¸  DEV deployment - release artifacts oluÅŸturulmadÄ±"
        fi

  # 7. Monitoring metrics gÃ¶nder
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“Š Monitoring metrics gÃ¶nderiliyor..."
        
        # Custom metric gÃ¶nder
        gcloud logging write hss-deployment \
          "Backend deployment completed successfully" \
          --severity=INFO \
          --payload-type=json \
          --payload='{
            "service": "hss-backend",
            "environment": "${_ENVIRONMENT}",
            "version": "${_VERSION}",
            "commit_sha": "${SHORT_SHA}",
            "deployment_time": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
          }'
        
        echo "âœ… Monitoring metrics gÃ¶nderildi!"

# Substitution variables
substitutions:
  _REGION: 'europe-west3'
  _REPO_NAME: 'hss-backend'
  _SERVICE_ACCOUNT: 'hss-backend-sa@hss-cloud-473511.iam.gserviceaccount.com'
  _CONNECTION_NAME: 'hss-cloud-473511:europe-west3:hss-sql'
  _DB_USERNAME_SECRET: 'DB_USERNAME'
  _DB_PASSWORD_SECRET: 'DB_PASSWORD'
  _ENVIRONMENT: 'dev'
  _SERVICE_NAME: 'hss-backend-dev'
  _SPRING_PROFILE: 'dev'
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '2'
  _VERSION: 'dev'
  _BUCKET_NAME: 'hss-releases-hss-cloud-473511'

# Build options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 100
  substitution_option: 'ALLOW_LOOSE'

# Timeout
timeout: '1200s'

# Images to be pushed to registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${_TAG_NAME}'